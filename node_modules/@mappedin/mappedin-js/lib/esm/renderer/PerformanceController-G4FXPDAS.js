import{L as C}from"./chunk-6V7LT3KT.js";import{a as S}from"./chunk-YEATVEJ5.js";import{a as o,f as e}from"./chunk-ZRT45YCM.js";S();var F,y,P=class{constructor(t){e(this,"_currentStats",{fps:0,ms:0,mb:0}),e(this,"view"),e(this,"timer"),e(this,"counter"),e(this,"onFPSChangeArray"),e(this,"onFPSChangeIndex"),e(this,"lastFPS",0),e(this,"SECONDS_TO_DECIDE",3),e(this,"MIN_FPS",38),e(this,"CRITICAL_FPS",24),e(this,"MAX_FPS",120),e(this,"MAX_MS",200),e(this,"MAX_MB",((null==(y=null==(F=window.performance)?void 0:F.memory)?void 0:y.jsHeapSizeLimit)||1/0)/1048576),e(this,"updateMappedinDevtools",o((()=>{let t="__MAPPEDIN_DEVTOOLS__";window[t]=window[t]||{};let e=window[t];e.showPerformancePanelArray=e.showPerformancePanelArray||[],e.hidePerformancePanelArray=e.hidePerformancePanelArray||[],e.showPerformancePanelArray.push((()=>this.showPerformancePanel())),e.hidePerformancePanelArray.push((()=>this.hidePerformancePanel()))}),"updateMappedinDevtools"));let{MAX_FPS:i,MAX_MS:s,MAX_MB:n}=this,a={fps:i,ms:s,mb:n};this.view=new d(t.debug,t.container,a),this.timer=new c,this.counter=new u,this.onFPSChangeArray=t.onFPSChangeArray,this.onFPSChangeIndex=t.dynamicPerformance?t.onFPSChangeArray.length:-1,this.updateMappedinDevtools()}static getDefaultOnFPSChangeArray(t){let{effectComposer:e}=t.renderer.implementation;return[()=>{null==e||e.setAntialiasConfiguration({antialias:!1}),t.paths.pathSegments.forEach((({arrowAnimationTween:t})=>{t.stop()}));for(let e in t.polygonMeshesById){let{material:i}=t.polygonMeshesById[e];i.map&&(i.map.anisotropy=1,i.needsUpdate=!0)}t.tryRendering()},()=>{null==e||e.setAmbientOcclusionConfiguration({aoEnabled:!1}),t.tryRendering()}]}updateStats(t){var e,i;let s=(null==(i=null==(e=window.performance)?void 0:e.memory)?void 0:i.usedJSHeapSize)||0;this._currentStats.fps=Math.min(t,this.MAX_FPS),this._currentStats.ms=Math.min(1e3/t,this.MAX_MS),this._currentStats.mb=Math.min(s/1048576,this.MAX_MB),this.view.updatePanels(this._currentStats)}isFPSSpiked(t){return Math.abs(this.lastFPS-t)/this.lastFPS>.1}updateOnFPSChangeIndex(t,e){let i=this.onFPSChangeIndex;return e&&i>0?i=0:t&&(i-=1),this.onFPSChangeIndex=C.clamp(i,-1,this.onFPSChangeArray.length),this.onFPSChangeIndex}handleFPSChange(t,e){let i=this.onFPSChangeIndex,s=this.updateOnFPSChangeIndex(t,e),n=this.onFPSChangeArray[s];!n||s===i||n(this.currentStats)}update(){let{fps:t,duration:e}=this.timer.update();if(e>=1e3){if(!this.isFPSSpiked(t)){let{lowFPS:e,criticalFPS:i}=this.counter.update(t,this.MIN_FPS,this.CRITICAL_FPS,this.SECONDS_TO_DECIDE);this.updateStats(t),this.handleFPSChange(e,i)}this.lastFPS=t,this.timer.reset()}}get currentStats(){return{...this._currentStats}}get dom(){return this.view.dom}hidePerformancePanel(){this.view.hidePerformancePanel()}showPerformancePanel(){this.view.showPerformancePanel()}};o(P,"PerformanceController");var b=P,m=class{constructor(){e(this,"beginTime",performance.now()),e(this,"frames",0),e(this,"duration",0)}reset(){this.duration=0,this.frames=0}update(){let t=performance.now(),e=t-this.beginTime;return this.frames++,this.duration+=e,this.beginTime=t,{duration:this.duration,fps:this.frames/(this.duration/1e3)}}};o(m,"PerformanceTimer");var c=m,f=class{constructor(){e(this,"criticalFpsCounter",0),e(this,"lowFpsCounter",0),e(this,"highFpsCounter",0)}update(t,e,i,s){let n=t<e,a=t<i;return this.criticalFpsCounter=a?this.criticalFpsCounter+1:0,this.lowFpsCounter=n?this.lowFpsCounter+1:0,this.highFpsCounter=n?0:this.highFpsCounter+1,this.lowFpsCounter===s?(this.lowFpsCounter=0,this.criticalFpsCounter===s?(this.criticalFpsCounter=0,{lowFPS:!0,highFPS:!1,criticalFPS:!0}):{lowFPS:!0,highFPS:!1,criticalFPS:!1}):this.highFpsCounter===s?(this.highFpsCounter=0,{lowFPS:!1,highFPS:!0,criticalFPS:!1}):(n?this.highFpsCounter=0:(this.lowFpsCounter=0,this.criticalFpsCounter=0),{lowFPS:!1,highFPS:!1,criticalFPS:!1})}};o(f,"PerformanceCounter");var u=f,g=class{constructor(t,i,s){var n;e(this,"mode",-1),e(this,"panels",[]),e(this,"appContainer"),e(this,"maxValues"),e(this,"debug"),e(this,"stats"),e(this,"container"),this.debug=t,this.appContainer=i,this.maxValues=s,this.container=this.createContainer(),this.addPanel(new l({name:"FPS",foregroundColor:"#0ff",backgroundColor:"#002"})),this.addPanel(new l({name:"MS",foregroundColor:"#0f0",backgroundColor:"#020"})),null!=(n=window.performance)&&n.memory&&this.addPanel(new l({name:"MB",foregroundColor:"#f08",backgroundColor:"#201"})),this.debug&&this.showPerformancePanel()}createContainer(){let t=document.createElement("div");return t.style.cssText="position:absolute;top:0;right:0;cursor:pointer;opacity:0.9;z-index:10000",t.addEventListener("click",(t=>{t.preventDefault(),this.showPanel(++this.mode%this.panels.length)})),t}addPanel(t){this.panels.push(t),this.container.appendChild(t.dom)}showPanel(t){this.panels.forEach(((e,i)=>{e.dom.style.display=i===t?"block":"none"})),this.mode=t}hidePerformancePanel(){this.container.parentNode&&(this.debug=!1,this.appContainer.removeChild(this.container))}showPerformancePanel(){this.container.parentNode||(this.debug=!0,this.stats&&this.updatePanels(this.stats),this.appContainer.appendChild(this.container))}updatePanels(t){this.stats=t,this.debug&&this.panels.forEach(((e,i)=>{0===i?e.update(t.fps,this.maxValues.fps):1===i?e.update(t.ms,this.maxValues.ms):2===i&&e.update(t.mb,this.maxValues.mb)}))}get dom(){return this.container}};o(g,"PerformanceView");var d=g,v=class{constructor(t){this.config=t,e(this,"min",1/0),e(this,"max",0),e(this,"canvas"),e(this,"context"),e(this,"PR",Math.round(window.devicePixelRatio||1)),e(this,"WIDTH",80*this.PR),e(this,"HEIGHT",48*this.PR),e(this,"TEXT_X",3*this.PR),e(this,"TEXT_Y",2*this.PR),e(this,"GRAPH_X",3*this.PR),e(this,"GRAPH_Y",15*this.PR),e(this,"GRAPH_WIDTH",74*this.PR),e(this,"GRAPH_HEIGHT",30*this.PR),this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.setupCanvas()}setupCanvas(){this.canvas.dataset.name=this.config.name,this.canvas.width=this.WIDTH,this.canvas.height=this.HEIGHT,this.canvas.style.width="".concat(this.WIDTH/this.PR,"px"),this.canvas.style.height="".concat(this.HEIGHT/this.PR,"px"),this.context.font="bold ".concat(9*this.PR,"px Helvetica,Arial,sans-serif"),this.context.textBaseline="top",this.context.fillStyle=this.config.backgroundColor,this.context.fillRect(0,0,this.WIDTH,this.HEIGHT),this.context.fillStyle=this.config.foregroundColor,this.context.fillText(this.config.name,this.TEXT_X,this.TEXT_Y),this.context.fillRect(this.GRAPH_X,this.GRAPH_Y,this.GRAPH_WIDTH,this.GRAPH_HEIGHT),this.context.fillStyle=this.config.backgroundColor,this.context.globalAlpha=.9,this.context.fillRect(this.GRAPH_X,this.GRAPH_Y,this.GRAPH_WIDTH,this.GRAPH_HEIGHT)}get dom(){return this.canvas}update(t,e){this.min=Math.min(this.min,t),this.max=Math.max(this.max,t);let{context:i,WIDTH:s,GRAPH_Y:n,GRAPH_WIDTH:a,GRAPH_HEIGHT:h,PR:o}=this;i.fillStyle=this.config.backgroundColor,i.globalAlpha=1,i.fillRect(0,0,s,n),i.fillStyle=this.config.foregroundColor,i.fillText("".concat(Math.round(t)," ").concat(this.config.name," (").concat(Math.round(this.min),"-").concat(Math.round(this.max),")"),this.TEXT_X,this.TEXT_Y),i.drawImage(this.canvas,this.GRAPH_X+o,this.GRAPH_Y,a-o,h,this.GRAPH_X,this.GRAPH_Y,a-o,h),i.fillRect(this.GRAPH_X+a-o,this.GRAPH_Y,o,h),i.fillStyle=this.config.backgroundColor,i.globalAlpha=.9,i.fillRect(this.GRAPH_X+a-o,this.GRAPH_Y,o,Math.round((1-t/e)*h))}};o(v,"Panel");var l=v;export{b as PerformanceController,d as PerformanceView};